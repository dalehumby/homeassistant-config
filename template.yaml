- sensor:
  - name: Greeting
    state: >
      Good
      {% if now().hour < 12 %}
        morning
      {% elif now().hour < 17 %}
        afternoon
      {% else %}
        evening
      {% endif %}

  - name: "Average temperature"
    device_class: temperature
    unit_of_measurement: "°C"
    state: >
      {% set bedroom = states('sensor.bedroom_temperature') | float %}
      {% set study = states('sensor.study_temperature') | float %}
      {{ ((bedroom + study) / 2) | round(1) }}

  - name: "Illuminance"
    icon: "mdi:theme-light-dark"
    state: >
      {% if states('sensor.outdoor_illuminance_average') not in ['unknown', 'unavailable'] %}
        {% if states('sensor.outdoor_illuminance_average') | int < 10 %}
          dark
        {% elif states('sensor.outdoor_illuminance_average') | int < 1000 %}
          {% if state_attr('sun.sun', 'rising') %}
            dawn
          {% else %}
            dusk
          {% endif %}
        {% elif states('sensor.outdoor_illuminance_average') | int < 10000 %}
          gloomy
        {% else %}
          bright
        {% endif %}
      {% endif %}

  - name: "Daily playlist"
    icon: mdi:spotify
    # ISO weekday is 1 (Mon) .. 7 (Sun)
    # Mon Discover weekly
    # Tue Daily mix 1
    # Wed Daily mix 2
    # Thr Daily mix 3
    # Fri Release radar
    # Sat Daily mix 5
    # Sun Daily mix 6
    state: >
      {% if now().isoweekday() == 1 %}
        https://open.spotify.com/playlist/37i9dQZEVXcBLCgPN4zUED?si=b8e6f7dde3da427d
      {% elif now().isoweekday() == 2 %}
        https://open.spotify.com/playlist/37i9dQZF1E3500CBHfZVid?si=04389d89d8db42ed
      {% elif now().isoweekday() == 3 %}
        https://open.spotify.com/playlist/37i9dQZF1E36xhkhhnd6OW?si=4ae2f81701bd43df
      {% elif now().isoweekday() == 4 %}
        https://open.spotify.com/playlist/37i9dQZF1E36PUMXDr0n6B?si=ec6d9bacc66d46e9
      {% elif now().isoweekday() == 5 %}
        https://open.spotify.com/playlist/37i9dQZEVXbc0jST94T3I3?si=79d8893fa3fb4a07
      {% elif now().isoweekday() == 6 %}
        https://open.spotify.com/playlist/37i9dQZF1E36QhxXBTH2RE?si=0995558a2ad9472b
      {% else %}
        https://open.spotify.com/playlist/37i9dQZF1E35TbkiCN416a?si=f0e348f27e804ec2
      {% endif %}
      
  - name: Balcony Dew Point
    device_class: temperature
    unit_of_measurement: "°C"
    state: >
      {{ states('sensor.balcony_temperature') | float - (100 - states('sensor.balcony_humidity') | int) / 5 }}

  - name: Apple Watch Loadshedding Stage
    state: >
      {% if states('sensor.loadshedding_stage') | int > 0 %}
        {{ states('sensor.loadshedding_stage') }}
      {% else %}
        ⚡️
      {% endif %}

  - name: Apple Watch Loadshedding Count-up
    state: >
      {{ min(max(1 - (as_timestamp(states('sensor.loadshedding_home_next')) - now().timestamp()) / 7200, 0), 1) }}

- binary_sensor:
  - name: Front door
    device_class: door
    state: >
      {{ is_state("binary_sensor.front_door_contact", "on") and 
         is_state("binary_sensor.diningroom_pir_occupancy", "on") 
      }}

  - name: Air quality
    device_class: smoke
    state: >
      {% if states('sensor.particulate_matter_2_5um_concentration') | float > 100 or
            states('sensor.particulate_matter_10_0um_concentration') | float > 200
      %}
        on
      {% else %}
        off
      {% endif %}

